#!/bin/bash

# Claude Code Commit Message Review Hook
# Automatically reviews staged changes and commit message before finalizing commit

set -e

# Get commit message file path (passed by git as $1)
COMMIT_MSG_FILE="$1"
if [ -z "$COMMIT_MSG_FILE" ]; then
    echo "Error: Commit message file not provided"
    exit 1
fi

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ¤– Running Claude Code review on staged changes and commit message...${NC}\n"

# Function to mask API key for display (show first 7 and last 3 characters)
mask_api_key() {
    local key="$1"
    if [ -z "$key" ]; then
        echo "(not set)"
        return
    fi
    local len=${#key}
    if [ $len -le 10 ]; then
        echo "***"
    else
        local prefix="${key:0:7}"
        local suffix="${key: -3}"
        echo "${prefix}***...***${suffix}"
    fi
}

# Load custom configuration if exists
REPO_ROOT=$(git rev-parse --show-toplevel)
CONFIG_FILE="$REPO_ROOT/.claude-review.env"

CONFIG_LOADED=false
if [ -f "$CONFIG_FILE" ]; then
    echo -e "${BLUE}ğŸ“ Configuration from .claude-review.env:${NC}"
    # Source the config file to load standard ANTHROPIC_* variables
    source "$CONFIG_FILE"
    CONFIG_LOADED=true
fi

# Set up API configuration for the review
# Disable all MCP servers and tools to avoid compatibility issues with proxy endpoints
# Model is specified via ANTHROPIC_MODEL env var, not CLI flag (for compatibility with all providers)
CLAUDE_CMD="claude --print --strict-mcp-config"

# Display configuration summary
if [ "$CONFIG_LOADED" = true ] || [ -n "$ANTHROPIC_API_KEY" ] || [ -n "$ANTHROPIC_AUTH_TOKEN" ] || [ -n "$ANTHROPIC_BASE_URL" ] || [ -n "$ANTHROPIC_MODEL" ]; then
    # Show what's configured
    API_KEY="${ANTHROPIC_API_KEY:-$ANTHROPIC_AUTH_TOKEN}"
    if [ -n "$API_KEY" ]; then
        MASKED_KEY=$(mask_api_key "$API_KEY")
        echo -e "   ${BLUE}ğŸ”‘ API Key:${NC} $MASKED_KEY"
    fi

    if [ -n "$ANTHROPIC_BASE_URL" ]; then
        echo -e "   ${BLUE}ğŸŒ Base URL:${NC} $ANTHROPIC_BASE_URL"
    fi

    if [ -n "$ANTHROPIC_MODEL" ]; then
        echo -e "   ${BLUE}ğŸ¤– Model:${NC} $ANTHROPIC_MODEL"
    fi

    if [ -n "$API_TIMEOUT_MS" ]; then
        echo -e "   ${BLUE}â±ï¸  Timeout:${NC} ${API_TIMEOUT_MS}ms"
    fi

    if [ -n "$CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC" ]; then
        echo -e "   ${BLUE}ğŸš« Disable non-essential traffic:${NC} enabled"
    fi

    echo ""
else
    echo -e "${BLUE}ğŸ“ Using default Claude Code configuration${NC}\n"
fi

# Check if Claude Code is installed
if ! command -v claude &> /dev/null; then
    echo -e "${RED}âŒ Claude Code is not installed.${NC}"
    echo -e "Install it from: https://claude.com/code"
    echo -e "Or run: ${YELLOW}npm install -g @anthropic/claude-code${NC}"
    echo -e "\n${YELLOW}Bypassing review for now...${NC}"
    exit 0  # Don't block commit if Claude not installed
fi

# Check if there are staged changes
if ! git diff --cached --quiet; then
    # Get list of staged files
    STAGED_FILES=$(git diff --cached --name-only)

    # Read the commit message
    COMMIT_MESSAGE=$(cat "$COMMIT_MSG_FILE")

    # Create temporary directory for review
    TEMP_DIR=$(mktemp -d)
    REVIEW_FILE="$TEMP_DIR/review_request.md"

    # Generate review request
    cat > "$REVIEW_FILE" << 'EOF'
Review the following staged changes and commit message before finalizing the commit. Focus on:

## Review Criteria for Go Code

1. **Code Quality**
   - Protential bugs and security issues
   - Go idioms and best practices
   - Error handling patterns
   - Code clarity and maintainability

2. **Concurrency Safety**
   - Proper goroutine management
   - Race condition risks
   - Channel usage patterns
   - Mutex/lock correctness

3. **Performance**
   - Memory allocations
   - Resource leaks
   - Inefficient patterns

4. **gRPC/API Security**
   - Input validation
   - Injection vulnerabilities
   - Authentication/authorization

5. **Testing**
   - Test coverage gaps
   - Edge cases

## Project Standards

Please check against our coding standards in CLAUDE.md if it exists.

## Remarks
- Please point out where the issues are with specific file and line numbers.

EOF

    # Add commit message section
    echo "" >> "$REVIEW_FILE"
    echo "## Commit Message" >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"
    echo '```' >> "$REVIEW_FILE"
    echo "$COMMIT_MESSAGE" >> "$REVIEW_FILE"
    echo '```' >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"
    echo "**Verify that:**" >> "$REVIEW_FILE"
    echo "- The commit message accurately describes the code changes" >> "$REVIEW_FILE"
    echo "- The scope of changes matches what the message claims (e.g., 'refactor only' should have no behavior changes)" >> "$REVIEW_FILE"
    echo "- There are no mismatches between intent and implementation" >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"

    # Add staged changes section
    echo "## Staged Changes" >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"

    # Append git diff with context
    echo "\`\`\`diff" >> "$REVIEW_FILE"
    git diff --cached >> "$REVIEW_FILE"
    echo "\`\`\`" >> "$REVIEW_FILE"

    echo "" >> "$REVIEW_FILE"
    echo "## Staged Files" >> "$REVIEW_FILE"
    echo "$STAGED_FILES" >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"

    echo "Provide a concise review with:" >> "$REVIEW_FILE"
    echo "1. Critical issues (must fix before commit)" >> "$REVIEW_FILE"
    echo "2. Important suggestions (should consider)" >> "$REVIEW_FILE"
    echo "3. Optional improvements" >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"
    echo "**IMPORTANT:** Your final verdict MUST be one of these (on its own line at the end):" >> "$REVIEW_FILE"
    echo "- If there are CRITICAL issues that MUST be fixed: ğŸ”´ BLOCK COMMIT" >> "$REVIEW_FILE"
    echo "- If code is acceptable to commit: âœ… APPROVED" >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"
    echo "Note: The verdict line should contain EXACTLY the text above (you may use markdown formatting)." >> "$REVIEW_FILE"

    # Display prompt file location and command for debugging
    echo -e "${BLUE}ğŸ’¾ Prompt file:${NC} $REVIEW_FILE"
    echo -e "${BLUE}ğŸ”§ Command:${NC} $CLAUDE_CMD < $REVIEW_FILE"
    echo ""
    echo -e "${YELLOW}â³ Analyzing code... (streaming output below)${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    # Run Claude Code review
    # Using --print mode to get direct output
    # Environment variables (ANTHROPIC_*) are already loaded from .claude-review.env if it exists
    # Stream output to user in real-time while also capturing it
    OUTPUT_FILE="$TEMP_DIR/claude_output.txt"

    # Temporarily disable exit-on-error to capture the exit code
    set +e
    $CLAUDE_CMD < "$REVIEW_FILE" 2>&1 | tee "$OUTPUT_FILE"
    CLAUDE_EXIT_CODE=${PIPESTATUS[0]}
    set -e

    # Read the captured output for later checks
    REVIEW_OUTPUT=$(cat "$OUTPUT_FILE")

    # Check if Claude command succeeded
    if [ $CLAUDE_EXIT_CODE -ne 0 ]; then
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ Error running Claude Code review${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo "$REVIEW_OUTPUT"
        echo ""
        echo -e "${YELLOW}Troubleshooting:${NC}"

        # Check for common issues
        if echo "$REVIEW_OUTPUT" | grep -qi "authentication\|unauthorized\|api.key"; then
            echo -e "  ${YELLOW}â€¢ Authentication issue detected${NC}"
            echo -e "    - Check ANTHROPIC_API_KEY in ${BLUE}.claude-review.env${NC}"
            echo -e "    - Or run: ${BLUE}claude auth${NC}"
        fi

        if echo "$REVIEW_OUTPUT" | grep -qi "connection\|network\|timeout"; then
            echo -e "  ${YELLOW}â€¢ Network/connection issue${NC}"
            echo -e "    - Check your internet connection"
            echo -e "    - Verify ANTHROPIC_BASE_URL is correct"
        fi

        if echo "$REVIEW_OUTPUT" | grep -qi "model"; then
            echo -e "  ${YELLOW}â€¢ Model issue${NC}"
            echo -e "    - Check ANTHROPIC_MODEL setting"
        fi

        echo ""
        echo -e "${YELLOW}To bypass this check, use:${NC} ${BLUE}git commit --no-verify${NC}"
        echo -e "${YELLOW}Debug: Check prompt at:${NC} $REVIEW_FILE"
        exit 1
    fi

    # Check for empty output
    if [ -z "$REVIEW_OUTPUT" ]; then
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ No output from Claude Code review${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo ""
        echo -e "${YELLOW}The review command succeeded but produced no output.${NC}"
        echo -e "${YELLOW}To bypass this check, use:${NC} ${BLUE}git commit --no-verify${NC}"
        echo -e "${YELLOW}Debug: Check prompt at:${NC} $REVIEW_FILE"
        exit 1
    fi

    # Review output was already displayed in real-time above
    # Just add a separator
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

    # Check if review recommends blocking
    # Use flexible pattern to handle markdown formatting, whitespace variations, etc.
    # Matches: "BLOCK COMMIT", "ğŸ”´ BLOCK COMMIT", "ğŸ”´ **BLOCK COMMIT**", etc.
    if echo "$REVIEW_OUTPUT" | grep -i -E "(ğŸ”´.*)?BLOCK[[:space:]]*COMMIT" > /dev/null; then
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ COMMIT BLOCKED${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${YELLOW}Critical issues found. Please address them before committing.${NC}"
        echo -e "${YELLOW}To bypass this check, use: ${NC}${BLUE}git commit --no-verify${NC}"
        echo -e "${YELLOW}Debug: Prompt saved at:${NC} $REVIEW_FILE"
        exit 1
    fi

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ… Review complete. Proceeding with commit...${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${BLUE}Debug: Prompt saved at:${NC} $REVIEW_FILE"
else
    echo -e "${YELLOW}No staged changes to review.${NC}"
fi

exit 0
