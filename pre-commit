#!/bin/bash

# Claude Code Pre-commit Review Hook
# Automatically reviews staged changes before commit

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}ğŸ¤– Running Claude Code review on staged changes...${NC}\n"

# Check if Claude Code is installed
if ! command -v claude &> /dev/null; then
    echo -e "${RED}âŒ Claude Code is not installed.${NC}"
    echo -e "Install it from: https://claude.com/code"
    echo -e "Or run: ${YELLOW}npm install -g @anthropic/claude-code${NC}"
    echo -e "\n${YELLOW}Bypassing review for now...${NC}"
    exit 0  # Don't block commit if Claude not installed
fi

# Check if there are staged changes
if ! git diff --cached --quiet; then
    # Get list of staged files
    STAGED_FILES=$(git diff --cached --name-only)

    # Create temporary directory for review
    TEMP_DIR=$(mktemp -d)
    REVIEW_FILE="$TEMP_DIR/review_request.md"

    # Generate review request
    cat > "$REVIEW_FILE" << 'EOF'
Review the following staged changes before commit. Focus on:

## Review Criteria for Go Code

1. **Code Quality**
   - Go idioms and best practices
   - Error handling patterns
   - Code clarity and maintainability

2. **Concurrency Safety**
   - Proper goroutine management
   - Race condition risks
   - Channel usage patterns
   - Mutex/lock correctness

3. **Performance**
   - Memory allocations
   - Resource leaks
   - Inefficient patterns

4. **Redis Integration** (if applicable)
   - Connection handling
   - Error recovery
   - Data structure usage

5. **gRPC/API Security**
   - Input validation
   - Injection vulnerabilities
   - Authentication/authorization

6. **Testing**
   - Test coverage gaps
   - Edge cases

## Project Standards

Please check against our coding standards in CLAUDE.md if it exists.

## Staged Changes

EOF

    # Append git diff with context
    echo "\`\`\`diff" >> "$REVIEW_FILE"
    git diff --cached >> "$REVIEW_FILE"
    echo "\`\`\`" >> "$REVIEW_FILE"

    echo "" >> "$REVIEW_FILE"
    echo "## Staged Files" >> "$REVIEW_FILE"
    echo "$STAGED_FILES" >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"

    echo "Provide a concise review with:" >> "$REVIEW_FILE"
    echo "1. Critical issues (must fix before commit)" >> "$REVIEW_FILE"
    echo "2. Important suggestions (should consider)" >> "$REVIEW_FILE"
    echo "3. Optional improvements" >> "$REVIEW_FILE"
    echo "" >> "$REVIEW_FILE"
    echo "If there are CRITICAL issues, end with: 'ğŸ”´ BLOCK COMMIT'" >> "$REVIEW_FILE"
    echo "Otherwise end with: 'âœ… APPROVED'" >> "$REVIEW_FILE"

    # Run Claude Code review
    # Using --print mode to get direct output
    REVIEW_OUTPUT=$(claude --print < "$REVIEW_FILE" 2>&1)

    # Display review
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}ğŸ“‹ Claude Code Review Results${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "$REVIEW_OUTPUT"
    echo ""

    # Check if review recommends blocking
    if echo "$REVIEW_OUTPUT" | grep -q "ğŸ”´ BLOCK COMMIT"; then
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${RED}âŒ COMMIT BLOCKED${NC}"
        echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        echo -e "${YELLOW}Critical issues found. Please address them before committing.${NC}"
        echo -e "${YELLOW}To bypass this check, use: ${NC}${BLUE}git commit --no-verify${NC}"
        rm -rf "$TEMP_DIR"
        exit 1
    fi

    # Clean up
    rm -rf "$TEMP_DIR"

    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ… Review complete. Proceeding with commit...${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
else
    echo -e "${YELLOW}No staged changes to review.${NC}"
fi

exit 0
